<%- include('partials/header', { title }) %>
<%
function getTextColor(bgColor) {
  if (!bgColor) return "#000";
  var r = parseInt(bgColor.substr(1,2),16);
  var g = parseInt(bgColor.substr(3,2),16);
  var b = parseInt(bgColor.substr(5,2),16);
  var yiq = ((r*299)+(g*587)+(b*114))/1000;
  return (yiq >= 128) ? "#000" : "#fff";
}
%>

<!-- Header con gradiente -->
<div class="bg-gradient bg-primary text-white py-4 mb-4 rounded-3 shadow-sm">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col">
        <h1 class="display-5 fw-bold mb-0">
          <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
        <p class="mb-0 opacity-75">Bienvenido a tu centro de control</p>
      </div>
      <div class="col-auto">
        <% if (!tokenExists) { %>
          <a href="/auth/google" class="btn btn-light btn-lg shadow-sm">
            <i class="bi bi-google"></i> Conectar Google Drive
          </a>
        <% } else { %>
          <button type="button" class="btn btn-light btn-lg shadow-sm" id="disconnectBtn">
            <i class="bi bi-google text-danger"></i> Desconectar Drive
          </button>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Carrusel de accesos rápidos -->
<div class="mb-5">
  <h3 class="mb-3"><i class="bi bi-lightning-charge"></i> Accesos Rápidos</h3>
  <div id="quickAccessCarousel" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <a href="/clientes" class="text-decoration-none">
              <div class="card border-0 shadow-sm h-100 quick-access-card">
                <div class="card-body text-center py-4">
                  <i class="bi bi-people-fill text-primary mb-2" style="font-size: 2.5rem;"></i>
                  <h6 class="mb-0">Clientes</h6>
                </div>
              </div>
            </a>
          </div>
          <div class="col-6 col-md-3">
            <a href="/trabajos/calendario" class="text-decoration-none">
              <div class="card border-0 shadow-sm h-100 quick-access-card">
                <div class="card-body text-center py-4">
                  <i class="bi bi-calendar3 text-success mb-2" style="font-size: 2.5rem;"></i>
                  <h6 class="mb-0">Calendario</h6>
                </div>
              </div>
            </a>
          </div>
          <div class="col-6 col-md-3">
            <a href="/trabajos" class="text-decoration-none">
              <div class="card border-0 shadow-sm h-100 quick-access-card">
                <div class="card-body text-center py-4">
                  <i class="bi bi-briefcase-fill text-info mb-2" style="font-size: 2.5rem;"></i>
                  <h6 class="mb-0">Trabajos</h6>
                </div>
              </div>
            </a>
          </div>
          <div class="col-6 col-md-3">
            <a href="/categorias" class="text-decoration-none">
              <div class="card border-0 shadow-sm h-100 quick-access-card">
                <div class="card-body text-center py-4">
                  <i class="bi bi-tags-fill text-warning mb-2" style="font-size: 2.5rem;"></i>
                  <h6 class="mb-0">Categorías</h6>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>
      <div class="carousel-item">
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <a href="/estados" class="text-decoration-none">
              <div class="card border-0 shadow-sm h-100 quick-access-card">
                <div class="card-body text-center py-4">
                  <i class="bi bi-flag-fill text-danger mb-2" style="font-size: 2.5rem;"></i>
                  <h6 class="mb-0">Estados</h6>
                </div>
              </div>
            </a>
          </div>
          <div class="col-6 col-md-3">
            <a href="/urgencias" class="text-decoration-none">
              <div class="card border-0 shadow-sm h-100 quick-access-card">
                <div class="card-body text-center py-4">
                  <i class="bi bi-exclamation-triangle-fill text-warning mb-2" style="font-size: 2.5rem;"></i>
                  <h6 class="mb-0">Urgencias</h6>
                </div>
              </div>
            </a>
          </div>
          <div class="col-6 col-md-3">
            <a href="/herramientas" class="text-decoration-none">
              <div class="card border-0 shadow-sm h-100 quick-access-card">
                <div class="card-body text-center py-4">
                  <i class="bi bi-tools text-secondary mb-2" style="font-size: 2.5rem;"></i>
                  <h6 class="mb-0">Herramientas</h6>
                </div>
              </div>
            </a>
          </div>
          <div class="col-6 col-md-3">
            <a href="/trabajos/nuevo" class="text-decoration-none">
              <div class="card border-0 shadow-sm h-100 quick-access-card bg-primary text-white">
                <div class="card-body text-center py-4">
                  <i class="bi bi-plus-circle-fill mb-2" style="font-size: 2.5rem;"></i>
                  <h6 class="mb-0">Nuevo Trabajo</h6>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#quickAccessCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
      <span class="visually-hidden">Anterior</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#quickAccessCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
      <span class="visually-hidden">Siguiente</span>
    </button>
  </div>
</div>

<!-- Estadísticas principales -->
<div class="mb-4">
  <h3 class="mb-3"><i class="bi bi-graph-up"></i> Estadísticas</h3>
  <div class="row g-4">
    <!-- Card de Clientes -->
    <div class="col-md-4">
      <a href="/clientes" class="text-decoration-none">
        <div class="card stat-card border-0 shadow h-100 overflow-hidden">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <h6 class="text-muted mb-1">Total Clientes</h6>
                <h2 class="mb-0 fw-bold"><%= totalClientes %></h2>
              </div>
              <div class="col-auto">
                <div class="stat-icon bg-primary bg-opacity-10 rounded-circle p-3">
                  <i class="bi bi-people-fill text-white" style="font-size: 1.5rem;"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer bg-primary bg-opacity-10 border-0 py-2">
            <small class="text-primary fw-semibold">Ver todos <i class="bi bi-arrow-right"></i></small>
          </div>
        </div>
      </a>
    </div>

    <!-- Cards de Categorías -->
    <% if (Array.isArray(categorias)) { categorias.forEach(cat => { %>
      <div class="col-md-4">
        <a href="/trabajos?categoria=<%= cat.id %>" class="text-decoration-none">
          <div class="card stat-card border-0 shadow h-100 overflow-hidden">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="text-muted mb-1"><%= cat.nombre %></h6>
                  <h2 class="mb-0 fw-bold">
                    <%= trabajosPorCategoria && trabajosPorCategoria[cat.nombre] ? trabajosPorCategoria[cat.nombre] : 0 %>
                  </h2>
                </div>
                <div class="col-auto">
                  <div class="stat-icon bg-light rounded-circle p-3">
                    <i class="<%= cat.icono || 'bi bi-tag' %>" style="font-size: 1.5rem;"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer bg-light border-0 py-2">
              <small class="text-muted fw-semibold">Ver trabajos <i class="bi bi-arrow-right"></i></small>
            </div>
          </div>
        </a>
      </div>
    <% }) } %>
  </div>
</div>

<!-- Estados -->
<% if (Array.isArray(estados) && estados.length > 0) { %>
<div class="mb-4">
  <h3 class="mb-3"><i class="bi bi-flag"></i> Estados de Trabajos</h3>
  <div class="row g-4">
    <% estados.forEach(estado => { %>
      <div class="col-md-4">
        <a href="/trabajos?estado=<%= estado.id %>" class="text-decoration-none">
          <div class="card stat-card border-0 shadow h-100 overflow-hidden">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="mb-1" style="color: <%= estado.color %>"><%= estado.nombre %></h6>
                  <h2 class="mb-0 fw-bold">
                    <%= trabajosPorEstado && trabajosPorEstado[estado.nombre] ? trabajosPorEstado[estado.nombre] : 0 %>
                  </h2>
                </div>
                <div class="col-auto">
                  <div class="stat-icon rounded-circle p-3" style="background-color: <%= estado.color %>15;">
                    <i class="<%= estado.icono || 'bi bi-flag' %>" style="font-size: 1.5rem; color: <%= estado.color %>;"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer border-0 py-2" style="background-color: <%= estado.color %>15;">
              <small class="fw-semibold" style="color: <%= estado.color %>">Ver trabajos <i class="bi bi-arrow-right"></i></small>
            </div>
          </div>
        </a>
      </div>
    <% }) %>
  </div>
</div>
<% } %>

<%- include('partials/alerts') %>

<style>
  .quick-access-card {
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .quick-access-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }
  
  .stat-card {
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15) !important;
  }
  
  .stat-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .carousel-control-prev,
  .carousel-control-next {
    width: 5%;
  }
  
  .carousel-control-prev-icon,
  .carousel-control-next-icon {
    width: 2rem;
    height: 2rem;
  }
  
  @media (max-width: 768px) {
    .carousel-control-prev,
    .carousel-control-next {
      display: none;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('disconnectBtn');
  if (btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      showLoader('Desconectando Google Drive...');
      fetch('/disconnect-drive')
        .then(() => {
          setTimeout(() => {
            hideLoader();
            window.location.href = '/dashboard';
          }, 1200);
        });
    });
  }
});
</script>

<%- include('partials/footer') %>